{% extends '@WebProfiler/Profiler/layout.html.twig' %}

{% block toolbar %}
    {% set icon %}
        <span class="icon">
            <svg width="20" height="28" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 28">
                <path d="M13 0L0 16h8l-2 12 15-18h-8z" fill="#AAA" stroke="#999" stroke-width="0.5"/>
            </svg>
        </span>
        <span class="sf-toolbar-value">{{ collector.queryCount }}</span>
        {% if collector.totalTime > 0 %}
            <span class="sf-toolbar-info-piece-additional-detail">
                <span class="sf-toolbar-label">in</span>
                <span class="sf-toolbar-value">{{ '%0.2f'|format(collector.totalTime * 1000) }}</span>
                <span class="sf-toolbar-label">ms</span>
            </span>
        {% endif %}
    {% endset %}

    {% set text %}
        <div class="sf-toolbar-info-piece">
            <b>Typesense Queries</b>
            <span class="sf-toolbar-status">{{ collector.queryCount }}</span>
        </div>
        <div class="sf-toolbar-info-piece">
            <b>Total Time</b>
            <span>{{ '%0.2f'|format(collector.totalTime * 1000) }} ms</span>
        </div>
        {% if collector.failedQueries > 0 %}
        <div class="sf-toolbar-info-piece">
            <b>Failed</b>
            <span class="sf-toolbar-status sf-toolbar-status-red">{{ collector.failedQueries }}</span>
        </div>
        {% endif %}
    {% endset %}

    {{ include('@WebProfiler/Profiler/toolbar_item.html.twig', { link: profiler_url, status: collector.failedQueries > 0 ? 'red' : '' }) }}
{% endblock %}

{% block head %}
    {{ parent() }}
    <style>
        /* Typesense brand colors */
        :root {
            --typesense-green: #c0ff58;
            --typesense-blue: #353fd7;
            --badge-typesense-background: transparent;
            --badge-typesense-border: 1px solid #9fcc45;
            --badge-typesense-color: #9fcc45;
            --badge-info-background: transparent;
            --badge-info-border: 1px solid #5865f2;
            --badge-info-color: #5865f2;
        }

        /* Custom label styles matching Symfony pattern */
        .label.collection {
            background: var(--badge-typesense-background);
            border: var(--badge-typesense-border);
            color: var(--badge-typesense-color);
        }
        .label.info {
            background: var(--badge-info-background);
            border: var(--badge-info-border);
            color: var(--badge-info-color);
        }

        /* Query header layout */
        .query-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #f5f5f5;
            border-left: 3px solid #999;
            margin: 15px 0 10px 0;
        }
        .query-header.status-error {
            border-left-color: #b0413e;
            background: #fce4e4;
        }
        .query-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Vector/Payload collapsible */
        details {
            max-width: 100%;
            overflow: hidden;
            display: block;
            width: 100%;
        }
        details summary {
            cursor: pointer;
            color: #3f51b5;
            text-decoration: underline;
            padding: 5px;
            background: #f0f0f0;
            border-radius: 3px;
            display: inline-block;
            user-select: none;
        }
        details[open] {
            display: block;
        }
        details summary:hover {
            background: #e0e0e0;
        }
        details pre {
            overflow: auto;
            max-height: 400px;
            max-width: 100%;
            width: 100%;
            word-wrap: break-word;
            white-space: pre-wrap;
            margin: 10px 0;
            padding: 10px;
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 11px;
            line-height: 1.4;
            box-sizing: border-box;
        }
        /* Force table cells with details to not overflow */
        table td:has(details) {
            max-width: 600px;
            overflow: hidden;
            vertical-align: top;
        }
        table td {
            vertical-align: top;
        }

        /* Nested tables inside details */
        details table {
            width: 100%;
            margin-top: 10px;
            border-collapse: collapse;
        }
        details table td {
            padding: 5px 8px;
            vertical-align: top;
            border-bottom: 1px solid #e0e0e0;
        }
        details h5 {
            margin: 10px 0 5px 0;
            color: #666;
            font-size: 13px;
        }

        /* Dark mode support */
        .theme-dark {
            --badge-typesense-background: transparent;
            --badge-typesense-border: 1px solid #c0ff58;
            --badge-typesense-color: #c0ff58;
            --badge-typesense-shadow: 0 0 0 3px rgba(192, 255, 88, 0.15);
            --badge-info-background: transparent;
            --badge-info-border: 1px solid #7c8aff;
            --badge-info-color: #7c8aff;
            --badge-info-shadow: 0 0 0 3px rgba(124, 138, 255, 0.15);
        }
        .theme-dark .query-header {
            background: #2d2d2d;
            border-left-color: #666;
        }
        .theme-dark .query-header.status-error {
            background: #4a2020;
            border-left-color: #b0413e;
        }
        .theme-dark details summary {
            background: #2d2d2d;
            color: #6b9aff;
        }
        .theme-dark details summary:hover {
            background: #3d3d3d;
        }
        .theme-dark details pre {
            background: #2d2d2d;
            border-color: #444;
            color: #ddd;
        }
        .theme-dark details table td {
            border-bottom-color: #444;
        }
        .theme-dark details h5 {
            color: #aaa;
        }
    </style>
{% endblock %}

{% block menu %}
    <span class="label {{ collector.failedQueries > 0 ? 'label-status-error' : '' }}">
        <span class="icon">
            <svg width="20" height="28" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 28">
                <path d="M13 0L0 16h8l-2 12 15-18h-8z" fill="#AAA" stroke="#999" stroke-width="0.5"/>
            </svg>
        </span>
        <strong>Typesense</strong>
        {% if collector.queryCount > 0 %}
            <span class="count">
                <span>{{ collector.queryCount }}</span>
            </span>
        {% endif %}
    </span>
{% endblock %}

{% block panel %}
    <h2>Typesense Queries</h2>

    <div class="metrics">
        <div class="metric">
            <span class="value">{{ collector.queryCount }}</span>
            <span class="label">Queries</span>
        </div>
        <div class="metric">
            <span class="value">{{ '%0.2f'|format(collector.totalTime * 1000) }} ms</span>
            <span class="label">Total Time</span>
        </div>
        {% if collector.failedQueries > 0 %}
        <div class="metric">
            <span class="value">{{ collector.failedQueries }}</span>
            <span class="label">Failed Queries</span>
        </div>
        {% endif %}
    </div>

    {% if collector.queries is empty %}
        <div class="empty">
            <p>No Typesense queries were executed.</p>
        </div>
    {% else %}
        <h2>Query Details</h2>

        {% for query in collector.queries %}
            <div class="query-header {{ query.error ? 'status-error' : '' }}">
                <div class="query-header-left">
                    <strong>#{{ loop.index }}</strong>
                    <span class="label label status-success">{{ query.method ?? 'GET' }}</span>
                    <code>{{ query.endpoint }}</code>
                </div>
                <span class="sf-toolbar-status">{{ '%0.2f'|format(query.duration * 1000) }} ms</span>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Property</th>
                        <th>Value</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>URL</strong></td>
                        <td><code>{{ query.url ?? (query.endpoint ?? 'N/A') }}</code></td>
                    </tr>
                    <tr>
                        <td><strong>Method</strong></td>
                        <td>
                            <span class="label label status-success">
                                {{ query.method ?? 'GET' }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>Operation</strong></td>
                        <td>{{ query.operation }}</td>
                    </tr>
                    {% if query.collection is defined %}
                    <tr>
                        <td><strong>Collection</strong></td>
                        <td>
                            <span class="label collection">{{ query.collection }}</span>
                        </td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td><strong>Duration</strong></td>
                        <td><span class="sf-toolbar-status">{{ '%0.2f'|format(query.duration * 1000) }} ms</span></td>
                    </tr>
                    {% if query.method in ['POST', 'PUT', 'PATCH'] and query.params is not empty %}
                    <tr>
                        <td><strong>Payload</strong></td>
                        <td>
                            <details>
                                <summary>üì¶ View payload ({{ query.params|length }} parameters)</summary>
                                <pre>{{ query.params|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
                            </details>
                        </td>
                    </tr>
                    {% endif %}
                    {% if query.response is defined and query.response %}
                    <tr>
                        <td><strong>Results</strong></td>
                        <td>
                            <span class="label status-success">{{ query.response.hits ?? 0 }} hits</span>
                            {% if query.response.search_time_ms is defined %}
                                <span class="label info">{{ query.response.search_time_ms }} ms (Typesense)</span>
                            {% endif %}
                            {% if query.response.facets_count is defined and query.response.facets_count > 0 %}
                                <span class="label info">{{ query.response.facets_count }} facets</span>
                            {% endif %}
                            {% if query.response.page is defined %}
                                <span class="label info">page {{ query.response.page }}</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>

            {% if query.params %}
                <h4>Parameters</h4>
                <table>
                    <thead>
                        <tr>
                            <th>Key</th>
                            <th>Value</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for key, value in query.params %}
                        <tr>
                            <td>{{ key }}</td>
                            <td>
                                {% if key == 'vector_query' %}
                                    <details>
                                        <summary>üîç Vector query ({{ value|length }} chars)</summary>
                                        <pre>{{ value|replace({',': ',\n'}) }}</pre>
                                    </details>
                                {% elseif key == 'searches' and value is iterable %}
                                    <details>
                                        <summary>üì¶ View Multi-search queries ({{ value|length }} searches)</summary>
                                        {% for idx, search in value %}
                                            <h5>Search #{{ idx + 1 }}</h5>
                                            <table>
                                                <tbody>
                                                {% for skey, svalue in search %}
                                                    <tr>
                                                        <td><strong>{{ skey }}</strong></td>
                                                        <td>
                                                            {% if skey == 'vector_query' %}
                                                                <details>
                                                                    <summary>üîç Vector query ({{ svalue|length }} chars)</summary>
                                                                    <pre>{{ svalue|replace({',': ',\n'}) }}</pre>
                                                                </details>
                                                            {% elseif svalue is iterable %}
                                                                <pre>{{ svalue|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
                                                            {% else %}
                                                                {{ svalue }}
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                                </tbody>
                                            </table>
                                        {% endfor %}
                                    </details>
                                {% elseif value is iterable %}
                                    <pre>{{ value|json_encode(constant('JSON_PRETTY_PRINT')) }}</pre>
                                {% elseif value is same as(true) %}
                                    <span class="label status-success">true</span>
                                {% elseif value is same as(false) %}
                                    <span class="label status-error">false</span>
                                {% else %}
                                    {{ value }}
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% endif %}

            {% if query.error %}
                <h4>Error</h4>
                <div class="status-error">
                    <strong>Error:</strong> {{ query.error }}
                </div>
            {% endif %}

            <hr />
        {% endfor %}
    {% endif %}
{% endblock %}
